# Growth Lab Deep Search - ETL Production Configuration
#
# This configuration is optimized for GCP deployment (VM and Cloud Run).
# Environment variables will override values where specified.
#
# Key differences from development config:
# - GCS bucket paths instead of local paths
# - Cloud-optimized rate limits and concurrency
# - Enhanced retry policies for network reliability
# - Production logging configuration

# Environment settings
environment: "production"  # Production environment

# Data sources
sources:
  growth_lab:
    base_url: "https://growthlab.hks.harvard.edu/publications-home/repository"
    scrape_delay: 2.0  # seconds between requests
    concurrency_limit: 2  # Maximum number of concurrent requests
    max_retries: 5  # Maximum number of retries for failed requests
    retry_base_delay: 5.0  # Initial delay in seconds before retrying
    retry_max_delay: 30.0  # Maximum delay in seconds before retrying
    max_concurrent_downloads: 10
    download_timeout: 60
    redownload_existing: false
    remove_outdated_files: true

  openalex:
    author_id: "A5034550995" # Ricardo Hausmann's author ID
    email: "parlay.donegal.0j@icloud.com" # for polite OpenAlex API use
    unpaywall_email: "parlay.donegal.0j@icloud.com" # for Unpaywall API access
    max_retries_per_page: 3
    max_overall_retries: 10
    redownload_existing: false
    remove_outdated_files: true

# Growth Lab file downloader configuration
gl_file_downloader:
  download_delay: 1.0
  max_retries: 5
  retry_base_delay: 1.0
  retry_max_delay: 60.0
  min_file_size: 1024  # 1KB
  max_file_size: 100_000_000  # 100MB
  user_agent_list:
    - "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
    - "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
    - "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15"
    - "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/120.0.0.0"

# File processing
file_processing:
  ocr:
    default_model: "unstructured"  # Lightweight pdfminer-based extraction (no torch needed)
    max_concurrent: 4
    chunk_size: 1000
    chunk_overlap: 200
    language_detection_pages: 5
    max_pages: 250            # Skip PDFs longer than this (0 = no limit)

    unstructured:
      strategy: "fast"        # pdfminer-based, no ML models
      languages: ["eng"]
      extract_images: false

  embedding:
    model: "openrouter"       # API-based embeddings (no torch needed)
    model_name: "qwen/qwen3-embedding-8b"  # lowercase = OpenRouter format
    dimensions: 1024               # MRL truncation from native 4096; changing requires full re-embedding
    max_tokens: 32768              # Qwen3-Embedding-8B context window
    batch_size: 32
    max_retries: 5                 # Increased retries for cloud reliability
    retry_delays: [2, 5, 10]        # Longer delays for cloud networking
    timeout: 60                     # Increased timeout for cloud API calls
    rate_limit_delay: 0.2          # Slightly increased delay for rate limits

  chunking:
    enabled: true
    strategy: "hybrid"             # Options: fixed, sentence, structure, hybrid
    # NOTE: All size limits below are in TOKENS (not characters) to ensure
    # compatibility with embedding model token limits (Qwen3-Embedding-8B: 32768)
    chunk_size: 500                # target tokens per chunk
    chunk_overlap: 50              # tokens of overlap between chunks
    min_chunk_size: 50             # minimum viable chunk size in tokens
    max_chunk_size: 8000           # maximum tokens (embedding model limit is 8192)
    preserve_structure: true       # respect document hierarchy (headers, sections)
    respect_sentences: true        # prefer sentence boundaries for splits
    structure_markers:             # patterns for detecting document structure
      - "^#{1,6}\\s+"              # markdown headers
      - "^\\d+\\.\\s+"             # numbered lists
      - "^[A-Z][A-Z\\s]+:"         # section labels like "INTRODUCTION:"

# Storage
storage:
  vector_db:
    name: "qdrant"
    collections:
      documents: "gl_documents"
      chunks: "gl_chunks"

# Runtime detection
runtime:
  detect_automatically: true
  slurm_indicators: ["SLURM_JOB_ID", "SLURM_STEP_ID"]
  # Local storage path is not used in production (GCS is used instead)
  local_storage_path: "data/"
  # GCS bucket name - should be set via environment variable GCS_BUCKET
  # This value is a fallback/default
  gcs_bucket: "${GCS_BUCKET:-gl-deep-search-data}"
  sync_to_gcs: true  # Always sync to GCS in production
